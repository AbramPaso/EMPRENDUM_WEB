<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - EMPRENDUM</title>
    <!-- Ajusta la ruta de tu icono si es necesario -->
    <link rel="icon" type="image/png" href="../image/Logo_individual.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <header class="header scrolled" style="background-color: #fff; position: sticky;">
        <nav class="navbar">
            <a href="#" class="nav-logo" style="color: #005a87;">EMPRENDUM <span style="font-size: 0.8rem;">APP</span></a>
            <ul class="nav-menu">
                <li><a href="dashboard.html" class="nav-link" style="color: #333;">Inicio</a></li>
                <li><a href="perfil.html" class="nav-link" style="color: #333;">Mi Perfil</a></li>
                <li><a href="#" onclick="cerrarSesion()" class="nav-link" style="color: #d9534f;">Salir</a></li>
            </ul>
        </nav>
    </header>

    <div class="dashboard-container">
        
        <div class="welcome-banner">
            <div>
                <h1>Hola, <span id="nombreUsuario">Colportor</span></h1>
                <p>Panel de Control - Resumen General</p>
            </div>
            <div>
                <a href="perfil.html" class="btn-cod" style="background: #fff; color: #005a87;">
                    <i class="fas fa-user-edit"></i> Completar Datos Personales
                </a>
            </div>
        </div>

        <h2 style="margin-bottom: 20px; color: #333;">Tus Estadísticas Acumuladas</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Colecciones Vendidas</h3>
                <div class="number" id="stat-colecciones">--</div>
                <p style="color: green;"><i class="fas fa-chart-line"></i> Total Acumulado</p>
            </div>
            <div class="stat-card">
                <h3>Monto Total ($)</h3>
                <div class="number" id="stat-monto">--</div>
                <p>Total Vendido</p>
            </div>
            <div class="stat-card">
                <h3>Horas Trabajadas</h3>
                <div class="number" id="stat-horas">--</div>
                <p>Tiempo invertido</p>
            </div>
            <div class="stat-card">
                <h3>Estudios Bíblicos</h3>
                <div class="number" id="stat-estudios">--</div>
                <p>Almas alcanzadas</p>
            </div>
        </div>

        <div class="form-grid">
            
            <!-- SECCIÓN: ENVIAR REPORTE SEMANAL -->
            <div class="report-section">
                <h3 style="color: #005a87; margin-bottom: 15px;"><i class="fas fa-calendar-week"></i> Enviar Reporte Semanal</h3>
                <form id="formReporteSemanal">
                    <div class="form-group">
                        <label>Semana (Número)</label>
                        <input type="number" id="sem_numero" placeholder="Ej: 42" required>
                    </div>
                    <div class="form-group">
                        <label>Año</label>
                        <input type="number" id="sem_anio" value="2025" required>
                    </div>
                    <div class="form-group">
                        <label>Colecciones Vendidas</label>
                        <input type="number" id="sem_colecciones" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label>Monto en Dólares ($)</label>
                        <input type="number" step="0.01" id="sem_monto" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>Horas Trabajadas</label>
                        <input type="number" step="0.5" id="sem_horas" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label>Estudios Bíblicos</label>
                        <input type="number" id="sem_estudios" placeholder="0" required>
                    </div>
                    <button type="submit" class="btn-submit">Enviar Reporte</button>
                </form>
            </div>

            <!-- SECCIÓN: SUBIR INFORME MENSUAL -->
            <div class="report-section">
                <h3 style="color: #005a87; margin-bottom: 15px;"><i class="fas fa-file-upload"></i> Informe Mensual</h3>
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                    Sube tu informe detallado en formato PDF o Word al finalizar el mes.
                </p>
                <form id="formInformeMensual">
                    <div class="form-group">
                        <label>Mes a reportar</label>
                        <select id="mes_reporte">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Año</label>
                        <input type="number" id="anio_reporte" value="2025" required>
                    </div>
                    <div class="form-group">
                        <label>Archivo (PDF/DOCX)</label>
                        <input type="file" id="archivo_informe" accept=".pdf,.doc,.docx" style="border: 2px dashed #ccc; padding: 20px;" required>
                    </div>
                    <button type="submit" class="btn-submit" style="background-color: #28a745;">Subir Informe</button>
                </form>
            </div>

        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api/reports';
        const token = localStorage.getItem('token');

        // 1. VERIFICAR AUTENTICACIÓN Y CARGAR DATOS
        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Decodificar nombre (visual)
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if(payload.nombre) document.getElementById('nombreUsuario').innerText = payload.nombre;
            } catch(e) {}

            cargarEstadisticas();
        });

        // 2. CARGAR ESTADÍSTICAS DEL DASHBOARD
        async function cargarEstadisticas() {
            try {
                const response = await fetch(`${API_URL}/dashboard-stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('stat-colecciones').innerText = data.total_colecciones || 0;
                    document.getElementById('stat-monto').innerText = '$' + (parseFloat(data.total_monto) || 0).toFixed(2);
                    document.getElementById('stat-horas').innerText = data.total_horas || 0;
                    document.getElementById('stat-estudios').innerText = data.total_estudios || 0;
                }
            } catch (error) {
                console.error("Error cargando estadísticas:", error);
            }
        }

        // 3. ENVIAR REPORTE SEMANAL
        document.getElementById('formReporteSemanal').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const datos = {
                semana_numero: document.getElementById('sem_numero').value,
                anio: document.getElementById('sem_anio').value,
                colecciones: document.getElementById('sem_colecciones').value,
                monto: document.getElementById('sem_monto').value,
                horas: document.getElementById('sem_horas').value,
                estudios: document.getElementById('sem_estudios').value
            };

            try {
                const response = await fetch(`${API_URL}/create-weekly`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(datos)
                });

                if (response.ok) {
                    alert("Reporte semanal enviado con éxito");
                    cargarEstadisticas(); // Recargar dashboard
                    e.target.reset();
                } else {
                    alert("Error al enviar reporte");
                }
            } catch (error) {
                console.error(error);
                alert("Error de conexión");
            }
        });

        // 4. SUBIR INFORME MENSUAL (ARCHIVO)
        document.getElementById('formInformeMensual').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('mes', document.getElementById('mes_reporte').value);
            formData.append('anio', document.getElementById('anio_reporte').value);
            formData.append('informe', document.getElementById('archivo_informe').files[0]);

            try {
                const response = await fetch(`${API_URL}/upload-monthly`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (response.ok) {
                    alert("Informe mensual subido correctamente");
                    e.target.reset();
                } else {
                    alert("Error al subir el archivo");
                }
            } catch (error) {
                console.error(error);
                alert("Error de conexión");
            }
        });

        function cerrarSesion() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>