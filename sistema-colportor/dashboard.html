<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Colportor - EMPRENDUM</title>
    <link rel="icon" type="image/png" href="../image/Logo_individual.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Estilo simple para el icono de ayuda */
        .help-icon {
            color: #005a87;
            cursor: help;
            margin-left: 5px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <!-- BARRA LATERAL -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-text">EMPRENDUM <span>APP</span></div>
        </div>
        <ul class="nav-links">
            <li><a href="#" onclick="mostrarSeccion('inicio')" id="nav-inicio" class="active"><i class="fas fa-home"></i> <span>Inicio</span></a></li>
            <li><a href="#" onclick="mostrarSeccion('reportes')" id="nav-reportes"><i class="fas fa-file-invoice-dollar"></i> <span>Reportes</span></a></li>
            <li><a href="#" onclick="mostrarSeccion('perfil')" id="nav-perfil"><i class="fas fa-user"></i> <span>Mi Perfil</span></a></li>
            <li><a href="#" onclick="mostrarSeccion('companeros')" id="nav-companeros"><i class="fas fa-users"></i> <span>Compañeros</span></a></li>
        </ul>
        <div class="logout-btn">
            <a href="#" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> <span>Salir</span></a>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content">

        <!-- VISTA: INICIO -->
        <section id="inicio" class="section-view active">
            <div class="section-header">
                <h2>Panel de Control</h2>
                <p>Bienvenido, <span id="nombreUsuarioDash">Colportor</span></p>
            </div>
            
            <!-- CAMBIO DE ORDEN EN TARJETAS: Título -> Texto -> Número -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Ventas ($)</h3>
                    <p style="color: #28a745;">Total acumulado</p>
                    <div class="number" id="stat-monto">--</div>
                </div>
                <div class="stat-card">
                    <h3>Colecciones</h3>
                    <p>entregadas</p>
                    <div class="number" id="stat-colecciones">--</div>
                </div>
                <div class="stat-card">
                    <h3>Horas</h3>
                    <p>trabajadas</p>
                    <div class="number" id="stat-horas">--</div>
                </div>
                <div class="stat-card">
                    <h3>Estudios</h3>
                    <p>bíblicos</p>
                    <div class="number" id="stat-estudios">--</div>
                </div>
            </div>
            
            <button class="btn-primary" style="width: auto; background: #6c757d;" onclick="mostrarSeccion('reportes')">
                <i class="fas fa-plus"></i> Nuevo Reporte
            </button>
        </section>

        <!-- VISTA: REPORTES -->
        <section id="reportes" class="section-view">
            <div class="section-header"><h2>Gestión de Reportes</h2></div>
            
            <!-- Formulario Semanal -->
            <div class="form-container">
                <h3><i class="fas fa-calendar-week"></i> Reporte Semanal</h3>
                <form id="formReporteSemanal">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Semana #</label>
                            <input type="number" id="sem_numero" placeholder="Ej: 42" required>
                        </div>
                        <!-- ELIMINADO: Input de Año (se envía automático) -->
                        
                        <div class="form-group">
                            <label>Colecciones</label>
                            <input type="number" id="sem_colecciones" placeholder="0" required>
                        </div>
                        
                        <div class="form-group">
                            <!-- CAMBIO: Label con ayuda (?) -->
                            <label>
                                Monto total depositado 
                                <i class="fas fa-question-circle help-icon" title="Reportar el dinero enviado en la semana, no el valor de las colecciones entregadas."></i>
                            </label>
                            <input type="number" step="0.01" id="sem_monto" placeholder="0.00" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Horas</label>
                            <input type="number" step="0.5" id="sem_horas" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label>Estudios</label>
                            <input type="number" id="sem_estudios" placeholder="0" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Enviar Reporte</button>
                </form>
            </div>

            <!-- Formulario Mensual -->
            <div class="form-container">
                <!-- CAMBIO: Icono de ayuda (?) en el título -->
                <h3>
                    <i class="fas fa-file-upload"></i> Informe Mensual (Archivo)
                    <i class="fas fa-question-circle help-icon" title="Enviar al final del mes, cuando el coach lo requiera."></i>
                </h3>
                
                <form id="formInformeMensual">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mes</label>
                            <select id="mes_reporte">
                                <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                                <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                                <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                                <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
                            </select>
                        </div>
                        <!-- Año automático también aquí si quieres, pero lo dejo visible por si reportan meses pasados -->
                        <div class="form-group">
                            <label>Año</label>
                            <input type="number" id="anio_reporte" value="2025" required>
                        </div>
                        <div class="form-group full-width">
                            <label>Archivo (PDF/DOC)</label>
                            <input type="file" id="archivo_informe" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="background-color: #28a745;">Subir Archivo</button>
                </form>
            </div>
        </section>

        <!-- VISTA: PERFIL -->
        <section id="perfil" class="section-view">
            <div class="profile-header">
                <img id="headerFoto" src="https://via.placeholder.com/100" class="profile-pic-large">
                <div class="profile-info-text"><h3 id="headerNombre">Cargando...</h3><p id="headerCarrera">Estudiante</p></div>
                <button class="edit-toggle-btn" onclick="toggleEditProfile()"><i class="fas fa-pen"></i> Editar</button>
            </div>
            <!-- SOLO LECTURA -->
            <div id="viewProfileMode" class="form-container">
                <h3>Información Personal</h3>
                <div class="form-grid">
                    <div><strong>Teléfono:</strong> <span id="view_telefono">--</span></div>
                    <div><strong>Procedencia:</strong> <span id="view_procedencia">--</span></div>
                    <div><strong>Estado Civil:</strong> <span id="view_civil">--</span></div>
                    <div class="full-width"><strong>Pensamiento:</strong> <p id="view_pensamiento" style="font-style: italic; color: #666; margin-top: 5px;">--</p></div>
                </div>
            </div>
            <!-- EDICIÓN -->
            <div id="editProfileMode" style="display: none;">
                <div class="form-container">
                    <h3>Editar Datos Laborales</h3>
                    <form id="formLaboral">
                        <div class="form-grid">
                            <div class="form-group full-width"><label>Cambiar Foto</label><input type="file" id="foto_perfil_input"></div>
                            <div class="form-group"><label>Ciudad de Misión</label><input type="text" id="lugar_colportar"></div>
                            <div class="form-group"><label>Unión</label><select id="union_trabajo"><option value="1">UVOC</option><option value="2">UVO</option></select></div>
                            <div class="form-group"><label>Campo</label><select id="campo_trabajo"><option value="1">AVCN</option><option value="2">MVY</option></select></div>
                            <div class="form-group full-width"><label>Pensamiento</label><textarea id="pensamiento"></textarea></div>
                        </div>
                        <button type="submit" class="btn-primary">Guardar Cambios Laborales</button>
                    </form>
                </div>
                <div class="form-container">
                    <h3>Datos Privados (Padres/Salud)</h3>
                    <form id="formPersonales">
                        <div class="form-grid">
                            <div class="form-group"><label>Padre</label><input type="text" id="padre_nombre"></div>
                            <div class="form-group"><label>Tlf Padre</label><input type="text" id="padre_telefono"></div>
                            <div class="form-group"><label>Madre</label><input type="text" id="madre_nombre"></div>
                            <div class="form-group"><label>Tlf Madre</label><input type="text" id="madre_telefono"></div>
                            <div class="form-group full-width"><label>Dirección</label><input type="text" id="direccion_origen"></div>
                            <div class="form-group"><label>Estado Civil</label>
                                <select id="estado_civil"><option value="Soltero">Soltero</option><option value="Casado">Casado</option><option value="Divorciado">Divorciado</option></select>
                            </div>
                            <div class="form-group"><label>Cónyuge</label><input type="text" id="conyuge_nombre"></div>
                            <div class="form-group full-width"><label>Alergias/Salud</label><textarea id="padecimiento"></textarea></div>
                        </div>
                        <button type="submit" class="btn-primary" style="background-color: #555;">Guardar Privados</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- VISTA: COMPAÑEROS -->
        <section id="companeros" class="section-view">
            <div class="section-header"><h2>Compañeros de Misión</h2><p>Conecta con otros colportores</p></div>
            <div class="colleagues-grid" id="listaCompaneros"><p>Cargando compañeros...</p></div>
        </section>
    </main>

    <!-- MODAL DE DETALLE -->
    <div id="modalCompanero" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="cerrarModal()">&times;</span>
            <img id="modalFoto" src="" class="profile-pic-large" style="margin: 0 auto 1rem;">
            <h3 id="modalNombre">Nombre</h3>
            <span id="modalCarrera" style="background: #eee; padding: 2px 10px; border-radius: 10px; font-size: 0.9rem;">Carrera</span>
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
            <p><strong><i class="fas fa-map-marker-alt"></i> Colportando en:</strong> <span id="modalLugar">--</span></p>
            <p><strong><i class="fas fa-phone"></i> Teléfono:</strong> <span id="modalTelefono">--</span></p>
            <div style="margin-top: 15px; font-style: italic; color: #555; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                "<span id="modalPensamiento">--</span>"
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        const token = localStorage.getItem('token');

        document.addEventListener('DOMContentLoaded', () => {
            if (!token) { window.location.href = 'login.html'; return; }
            cargarEstadisticas(); 
            cargarPerfil();       
        });

        function mostrarSeccion(idSeccion) {
            document.querySelectorAll('.section-view').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
            document.getElementById(idSeccion).classList.add('active');
            document.getElementById('nav-' + idSeccion).classList.add('active');
            if(idSeccion === 'companeros') cargarCompaneros();
            if(idSeccion === 'perfil') cargarPerfil(); 
        }

        async function cargarEstadisticas() {
            try {
                const res = await fetch(`${API_BASE}/reports/dashboard-stats`, { headers: { 'Authorization': `Bearer ${token}` } });
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('stat-colecciones').innerText = data.total_colecciones || 0;
                    document.getElementById('stat-monto').innerText = '$' + (parseFloat(data.total_monto) || 0).toFixed(2);
                    document.getElementById('stat-horas').innerText = data.total_horas || 0;
                    document.getElementById('stat-estudios').innerText = data.total_estudios || 0;
                }
            } catch(e) { console.error(e); }
        }

        // --- ENVIAR REPORTE SEMANAL (JS ACTUALIZADO) ---
        document.getElementById('formReporteSemanal').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Calculamos el año automáticamente aquí
            const currentYear = new Date().getFullYear();

            const datos = {
                semana_numero: document.getElementById('sem_numero').value,
                anio: currentYear, // <-- AÑO AUTOMÁTICO
                colecciones: document.getElementById('sem_colecciones').value,
                monto: document.getElementById('sem_monto').value,
                horas: document.getElementById('sem_horas').value,
                estudios: document.getElementById('sem_estudios').value
            };
            const res = await fetch(`${API_BASE}/reports/create-weekly`, {
                method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`}, body: JSON.stringify(datos)
            });
            if(res.ok) { 
                alert("Reporte Enviado"); 
                e.target.reset(); 
                cargarEstadisticas(); 
            }
        });

        document.getElementById('formInformeMensual').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('mes', document.getElementById('mes_reporte').value);
            formData.append('anio', document.getElementById('anio_reporte').value);
            formData.append('informe', document.getElementById('archivo_informe').files[0]);
            const res = await fetch(`${API_BASE}/reports/upload-monthly`, {
                method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData
            });
            if(res.ok) { alert("Archivo subido"); e.target.reset(); }
        });

        let isEditMode = false;
        function toggleEditProfile() {
            isEditMode = !isEditMode;
            document.getElementById('viewProfileMode').style.display = isEditMode ? 'none' : 'block';
            document.getElementById('editProfileMode').style.display = isEditMode ? 'block' : 'none';
        }

        async function cargarPerfil() {
            try {
                const res = await fetch(`${API_BASE}/profile`, { headers: { 'Authorization': `Bearer ${token}` }});
                const data = await res.json();
                document.getElementById('headerNombre').innerText = data.nombre_completo || 'Usuario';
                document.getElementById('nombreUsuarioDash').innerText = (data.nombre_completo || 'Usuario').split(' ')[0];
                document.getElementById('headerCarrera').innerText = data.carrera || 'Estudiante';
                if(data.foto_perfil_url) {
                    const rutaFoto = data.foto_perfil_url.replace(/\\/g, '/');
                    document.getElementById('headerFoto').src = `http://localhost:3000/${rutaFoto}`;
                }
                document.getElementById('view_telefono').innerText = data.telefono || 'No registrado';
                document.getElementById('view_procedencia').innerText = data.direccion_origen || 'No registrada';
                document.getElementById('view_civil').innerText = data.estado_civil_extra || 'Soltero';
                document.getElementById('view_pensamiento').innerText = data.pensamiento_bio || 'Sin pensamiento definido.';
                
                document.getElementById('lugar_colportar').value = data.lugar_colportar || '';
                document.getElementById('pensamiento').value = data.pensamiento_bio || '';
                document.getElementById('padre_nombre').value = data.padre_nombre || '';
                document.getElementById('padre_telefono').value = data.padre_telefono || '';
                document.getElementById('madre_nombre').value = data.madre_nombre || '';
                document.getElementById('madre_telefono').value = data.madre_telefono || '';
                document.getElementById('direccion_origen').value = data.direccion_origen || '';
                if(data.estado_civil_extra) document.getElementById('estado_civil').value = data.estado_civil_extra;
                document.getElementById('conyuge_nombre').value = data.conyuge_nombre || '';
                document.getElementById('padecimiento').value = data.padecimiento_medico || '';
            } catch(e) { console.error(e); }
        }

        document.getElementById('formLaboral').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            const fileInput = document.getElementById('foto_perfil_input');
            if (fileInput.files[0]) formData.append('foto_perfil', fileInput.files[0]);
            formData.append('lugar_colportar', document.getElementById('lugar_colportar').value);
            formData.append('union_trabajo', document.getElementById('union_trabajo').value);
            formData.append('campo_trabajo', document.getElementById('campo_trabajo').value);
            formData.append('pensamiento', document.getElementById('pensamiento').value);
            const res = await fetch(`${API_BASE}/profile/laboral`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
            if (res.ok) { alert("Perfil actualizado"); location.reload(); }
        });

        document.getElementById('formPersonales').addEventListener('submit', async (e) => {
            e.preventDefault();
            const datos = {
                padre_nombre: document.getElementById('padre_nombre').value,
                padre_telefono: document.getElementById('padre_telefono').value,
                madre_nombre: document.getElementById('madre_nombre').value,
                madre_telefono: document.getElementById('madre_telefono').value,
                direccion_origen: document.getElementById('direccion_origen').value,
                estado_civil: document.getElementById('estado_civil').value,
                conyuge_nombre: document.getElementById('conyuge_nombre').value,
                padecimiento: document.getElementById('padecimiento').value
            };
            const res = await fetch(`${API_BASE}/profile/personales`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(datos) });
            if (res.ok) alert("Datos guardados");
        });

        async function cargarCompaneros() {
            const container = document.getElementById('listaCompaneros');
            container.innerHTML = '<p>Cargando...</p>';
            try {
                const res = await fetch(`${API_BASE}/users/lista`, { headers: { 'Authorization': `Bearer ${token}` }});
                const usuarios = await res.json();
                container.innerHTML = '';
                usuarios.forEach(u => {
                    let foto = 'https://via.placeholder.com/150';
                    if(u.foto_perfil_url) foto = `http://localhost:3000/${u.foto_perfil_url.replace(/\\/g, '/')}`;
                    const card = `<div class="colleague-card" onclick="verDetalleCompanero(${u.id})"><img src="${foto}" class="colleague-pic"><h4 class="colleague-name">${u.nombre_completo}</h4><span class="colleague-role">${u.carrera || 'Estudiante'}</span></div>`;
                    container.innerHTML += card;
                });
            } catch(e) { container.innerHTML = '<p>Error cargando lista.</p>'; }
        }

        async function verDetalleCompanero(id) {
            try {
                const res = await fetch(`${API_BASE}/users/detalle/${id}`, { headers: { 'Authorization': `Bearer ${token}` }});
                const u = await res.json();
                document.getElementById('modalNombre').innerText = u.nombre_completo;
                document.getElementById('modalCarrera').innerText = u.carrera || 'Estudiante';
                document.getElementById('modalLugar').innerText = u.lugar_colportar || 'No especificado';
                document.getElementById('modalTelefono').innerText = u.telefono || 'Privado';
                document.getElementById('modalPensamiento').innerText = u.pensamiento_bio || 'Sin pensamiento.';
                let foto = 'https://via.placeholder.com/150';
                if(u.foto_perfil_url) foto = `http://localhost:3000/${u.foto_perfil_url.replace(/\\/g, '/')}`;
                document.getElementById('modalFoto').src = foto;
                document.getElementById('modalCompanero').style.display = 'flex';
            } catch(e) { console.error(e); }
        }

        function cerrarModal() { document.getElementById('modalCompanero').style.display = 'none'; }
        function cerrarSesion() { localStorage.removeItem('token'); window.location.href = 'login.html'; }
    </script>
</body>
</html>